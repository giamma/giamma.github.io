---
layout: post
title: How to use Hyperic to monitor Eclipse Virgo 3.6
date: '2014-08-30T11:08:00.001+02:00'
author: Giamma
tags:
- Monitoring
- Hyperic
- Tomcat
- Virgo
- OSGi
modified_time: '2014-08-30T11:08:40.834+02:00'
blogger_id: tag:blogger.com,1999:blog-7876506089821014047.post-421911790669575139
blogger_orig_url: https://devshards.blogspot.com/2014/08/how-to-use-hyperic-to-monitor-eclipse.html
---

Few days ago I started looking for a monitoring tool to track the health status of our <b>Virgo Server for Apache Tomcat</b> instances.<br /><br />As I could not find anything Virgo specific, I looked for an open source tool that supported Apache Tomcat 7.0.<br /><br />First try was <a href="http://www.moskito.org/" target="_blank">Moskito</a>, but it does not seem to support the&nbsp; OSGi-aware Tomcat that is embedded in Virgo. In any case I did not like the deployment approach, which requires to add Mosquito to every monitored Web App.<br /><br />So I searched for monitoring tools that used Tomcat JMX support, as I believed such tools should be unaffected by the OSGi runtime, and I found <a href="http://www.hyperic.com/" target="_blank">Hyperic</a>. <br /><br /><h3>Hyperic 5.8&nbsp;</h3><h3></h3>Hyperic is developed by SpringSource and there exists both an enterprise distribution (vCenter Hyperic) and a <a href="http://sourceforge.net/projects/hyperic-hq/" target="_blank">free-to-use</a> distribution.<br /><br />Hyperic consists of the Hyperic Server and the Hyperic Agent.<br /><br />The server is a Tomcat6-based Web application that uses PostgreSQL for storing historical data and which provides the monitoring console.<br /><br />The agent is a stand-alone Java application that integrates with the O.S. via the well known <a href="http://www.hyperic.com/products/sigar" target="_blank">Sigar</a> native library (used by <a href="http://jmeter.apache.org/" target="_blank">JMeter</a>, <a href="http://www.elasticsearch.org/" target="_blank">Elasticsearch</a> etc), and which features a number of plug-ins for different servers and database systems (WebSphere, WebLogic, JBoss, Tomcat, Apache, Oracle, DB/2,&nbsp; PostgreSQL, MySQL and many <a href="https://github.com/hyperic/hq/tree/master/hq-plugin" target="_blank">more</a>).<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://a.fsdn.com/con/app/proj/hyperic-hq/screenshots/196982.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://a.fsdn.com/con/app/proj/hyperic-hq/screenshots/196982.jpg" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">A screenshot taken from the SourceForge download page</td></tr></tbody></table><h4>Installation and usage</h4>You must first install the Hyperic Server, typically on a dedicated machine that you will be using for monitoring. Then you must install the Hyperic Agent on every server machine that you want to monitor.<br /><br />The Hyperic Agent will automatically discover running database systems and application servers on the machine where it is installed, and it will offer them as observable resources to the Hyperic Server.<br /><br />From the Hyperic Server console the administrator can select what to monitor (e.g. Apache Tomcat, MySQL, but also operating system CPU, SWAP, file system, I/O, network etc)<br /><br />The agent will then start sampling the requested items and will push the information to the console. which will be able to display historical data, paint graphs, and which can be configured to raise alerts when certain conditions are met (e.g. low disk space, high CPU usage, Tomcat process crashed etc etc).<br /><br /><h3>Tweaking the Virgo installation to pretend it's Tomcat 7</h3>Even if Virgo was created by SpringSource, Hyperic does not seem to support Virgo OOTB, or at least the open source edition does not seem to support Virgo. <br /><br />It however supports Tomcat 7.0 via an agent plug-in called <a href="http://tomcat-plugin.jar/">tomcat-plugin.jar</a>. <br />A quick look at the plug-in <a href="https://github.com/hyperic/hq/blob/master/hq-plugin/tomcat-plugin" target="_blank">sources</a> reveals the Tomcat 7.0 discovery process:<br /><ol><li>The plug-in uses a Sigar <a href="https://github.com/hyperic/hq/blob/master/hq-plugin/tomcat-plugin/src/main/resources/etc/hq-plugin.xml#L230" target="_blank">query</a> to identify running processes that are potential Tomcat servers. The query just looks for running Java processes that include parameter <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-Dcataliba.base=&lt;some_path&gt;</span> in the command line. </li><li>The version of Tomcat is determined by checking the existence of some files that are specific to each Tomcat version. For Tomcat 7, the file is <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;catalina.base&gt;/lib/tomcat-api.jar <span style="font-family: Arial,Helvetica,sans-serif;">(see <a href="https://github.com/hyperic/hq/blob/master/hq-plugin/tomcat-plugin/src/main/resources/etc/hq-plugin.xml#L616" target="_blank">here</a>)<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">.</span></span></span></li><li>Once Tomcat is identified, the agent will connect to the process to collect samples, provided that JMX support is enabled. Luckily enough JMX is enabled per default in Virgo.</li></ol>To have Virgo recognized as Tomcat 7.0:<br /><ol><li>Set JAVA_OPTS to -Dcatalina.base=&lt;VIRGO_INSTALLATION_FOLDER&gt; before starting Virgo: <br /><blockquote class="tr_bq"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">export JAVA_OPTS=-Dcatalina.base=/home/giamma/virgo</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></blockquote><blockquote class="tr_bq"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">./startup.sh</span></blockquote></li><li>&nbsp;Create an empty file named tomcat-api.jar in the Virgo lib folder:<br /><blockquote class="tr_bq"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">cd /home/giamma/virgo&nbsp;</span></blockquote><blockquote class="tr_bq"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">touch lib/tomcat-plugin.jar</span></blockquote></li></ol>Now start Virgo and after few seconds it will show up as a Tomcat 7 server in the Hyperic console.<br />Note that the Hyperic template for Tomcat 7 will use wrong defaults for log files etc, but you can change them after enrolling the Virgo server in the Hyperic console.<br /><br />In case you wonder, the<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> catalina.base</span> system property has no side effect on Virgo, see <a href="https://www.eclipse.org/forums/index.php/mv/msg/796484/1404664/#msg_1404664" target="_blank">here</a>.<br /><br /><h3>Patching the Agent to monitor global data sources</h3>The current Hyperic Agent plugin for Tomcat is capable of monitoring only data sources that are defined at the Web App level.<br /><br />If you are using Tomcat global data sources as we are doing (see <a href="http://devshards.blogspot.com/2012/10/global-jndi-support-in-virgo-server-35.html" target="_blank">here</a> for details), they will not be monitored by Hyperic.<br /><br />However, you can easily patch the tomcat-plugin.jar as explained <a href="https://communities.vmware.com/message/1935596#1935596" target="_blank">here</a>. Just remember that after patching the plug-in you must replace it both in the Hyperic Agent and in the Hyperic Server.<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">./agent-5.8.2/bundles/agent-5.8.2/pdk/plugins/tomcat-plugin.jar</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br />./server-5.8.2/hq-engine/hq-server/webapps/ROOT/WEB-INF/hq-plugins/tomcat-plugin.jar</span>