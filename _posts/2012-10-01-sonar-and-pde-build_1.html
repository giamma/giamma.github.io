---
layout: post
title: Sonar and PDE Build
date: '2012-10-01T22:31:00.002+02:00'
author: Giamma
tags:
- Sonar
- PDEBuild
- Code analysis
- Eclipse
- Build automation
- ANT
modified_time: '2012-10-12T23:52:32.756+02:00'
blogger_id: tag:blogger.com,1999:blog-7876506089821014047.post-7839453427236465125
blogger_orig_url: https://devshards.blogspot.com/2012/10/sonar-and-pde-build_1.html
---

[Originally posted on G+ on the 17th of January 2012] <br /><br />I finally completed the integration of  #Sonar  (<a class="ot-anchor" href="http://www.sonarsource.org/">http://www.sonarsource.org</a>) in our PDEBuild  (<a class="ot-anchor" href="http://eclipse.org/pde/pde-build/">http://eclipse.org/pde/pde-build/</a>) based build system.<br /><h4><b>Requirements</b></h4>I  was looking for an integration approach that would allow us to run the  analysis on our OSGi  bundles and to globally define default values  for as many configuration parameters as possible (to avoid copy/pasting  the same Sonar  configuration values in every project build script),  but I also wanted to provide project owners with convenient means of  tweaking the configuration parameters of their projects and overriding  default values when appropriate.<br /><h4><b>PDEBuild customBuildCallbacks.xml</b></h4>After playing a bit with the many customisation hooks that  #PDEBuild  offers (see <a class="ot-anchor" href="http://help.eclipse.org/galileo/topic/org.eclipse.pde.doc.user/tasks/pde_customization.htm">http://help.eclipse.org/galileo/topic/org.eclipse.pde.doc.user/tasks/pde_customization.htm</a>) I believe that the best option is to use per project custom build call backs<br />(<a class="ot-anchor" href="http://help.eclipse.org/indigo/index.jsp?topic=/org.eclipse.pde.doc.user/tasks/pde_custom_callbacks.htm">http://help.eclipse.org/indigo/index.jsp?topic=/org.eclipse.pde.doc.user/tasks/pde_custom_callbacks.htm</a>).<br />These  callbacks consist in a Ant script containing a number of predefined  targets (a template is included in the  #PDEBuild  bundle) that, if  declared in the project's <i>build.properties</i> file, will be invoked by  #PDEBuild  during many steps of each bundle's build process.<br /><h4><b>Some implementation details</b></h4>I  want Sonar  analysis to take place if and only if the source code  compiles successfully, therefore I believe the most appropriate callback  is the <i>post.name</i> target (which becomes <i>post.@dot</i> for those bundles that are deployed as JARs and <i>post.&lt;jarname.jar&gt;</i> for those bundles that are deployed as folders (in Eclipse the latter usually feature the <i>BundleShape: dir</i> header attribute in their <i>MANIFEST.MF</i> file).<br /><br />Being PDEBuild  an Ant based build process, my first try consisted in using the Sonar  Ant task (<a class="ot-anchor" href="http://docs.codehaus.org/display/SONAR/Analyse+with+Ant+Task">http://docs.codehaus.org/display/SONAR/Analyse+with+Ant+Task</a>)  but that failed because such Ant task plays some tricks with the  classloader to run Sonar  that are not OSGi  friendly and does not  work within the Eclipse Ant Runner (and therefore within PDEBuild  ),  even if you package the Sonar  Ant task as a bundle that contributes  to the Eclipse Ant runner.<br /><br />Luckily enough, Sonar  provides also a standalone Java application for performing the analysis called SonarRunner  (<a class="ot-anchor" href="http://docs.codehaus.org/display/SONAR/Analyse+with+a+simple+Java+Runner">http://docs.codehaus.org/display/SONAR/Analyse+with+a+simple+Java+Runner</a>),  which can be successfully executed by PDEBuild  . It's basically a  shell script that starts a JVM to run the Sonar  analyser. SonarRunner  requires a global configuration file  ($SONAR_RUNNER_HOME/conf/sonar-runner.properties) where you can set  database connection parameters, server URL as well as the default source  and binary folder (project relative path).<br /><br />Given that by convention most of our bundles have a single source folder named <i>src/</i> and that the vast majority of our bundles are deployed as JARs (in  which case PDEBuild  automatically names the binary folder <i>@dot</i> during compilation), the global file was a very good location for defining good defaults for most projects.<br /><br />The  remaining mandatory configuration parameters will be set on a  per-project basis in the PDE custom build callback, by creating a  dedicated properties file in the project root folder for SonarRunner   just before executing it, as documented in the SonarRunner  page.<br /><br />Eventually, my SonarRunner  global configuration looked like this:<br /><br /><pre class="brush: bash;"><br /><br />    #----- Default Sonar server<br />    sonar.host.url=http://localhost:9000<br /><br />    #----- MySQL<br />    sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8<br />    sonar.jdbc.driver=com.mysql.jdbc.Driver<br /><br />    #----- Global database settings<br />    sonar.jdbc.username=&lt;user><br />    sonar.jdbc.password=&lt;password><br /><br />    #----- Default directory layout<br />    sources=src/<br />    tests=test/<br />    binaries=@dot/<br /><br />    sonar.sourceEncoding=UTF-8<br /></pre> <br />and a project specific callback to perform the analysis looked like this:<br /><br /><br /><pre class="brush: xml;"><br />    &lt;target name="post.@dot"><br />         &lt;antcall target="sonar"/><br />    &lt;/target><br /><br />    &lt;target name="sonar" if="run.sonar"><br /><br />    &lt;propertyfile file="${plugin.destination}/sonar-project.properties"><br />    &lt;!-- ==== Common properties, should not be changed ====--><br />    &lt;entry key="sonar.projectKey" value="studio:${bundleId}"/><br />    &lt;entry key="sonar.projectName" value="${bundleId}"/><br />    &lt;entry key="sonar.projectVersion"                    <br />             value="${sonar.projectVersion}"/><br /><br />    &lt;!-- ==== Project specific properties --><br />    &lt;!-- &lt;entry key="sources" value="${plugin.destination}/src"/> --><br />    &lt;!-- &lt;entry key="binaries" value="${plugin.destination}/@dot"/>--><br /><br />    &lt;!-- == Additional Sonar properties. Add project specific properties here == --><br />    &lt;!-- &lt;entry key="sonar.exclusions" value="com/mycompany/*/.java,**/*Dummy.java"/> --><br />    &lt;!-- &lt;entry key="sonar.profile" value="MyProfile"/> --><br />    &lt;/propertyfile><br /><br />    &lt;exec spawn="false" command="${sonar.runner}" failonerror="true" /><br />    &lt;/target><br /></pre>where the property <i>run.sonar</i> is set globally somewhere earlier in the main build script, to make  sure that the analysis (which can be very time consuming if you enable a  lot of rules) is perfomed only if the build flavour is <i>nightly</i> or when explicitly requested by the build master.<br /><br /><b>Final comments</b><br />Congrats  to the Sonar  team for writing such a great piece of software! I am  really looking forward for the next release which, according to the  roadmap <a class="ot-anchor" href="http://www.sonarsource.org/roadmap/">http://www.sonarsource.org/roadmap/</a>,  should be out in January 2012 and may provide the ability to use   #Sonar  as a generic code review tool, as opposed to current version  2.12 which supports code review limited only to the violations reported  by Sonar.